import json
import numpy as np
from flask import Flask, request, url_for, redirect, render_template, jsonify, session
from flask_session import Session
import pandas as pd
import random
import uuid
from ast import literal_eval
import os
from scipy.stats import percentileofscore  # pip install scipy
import time
import collections
import redis
from datetime import datetime, timedelta


app = Flask(__name__)
# SESSION_TYPE = 'redis'
app.config['SESSION_TYPE'] = 'redis'
app.config['SESSION_REDIS'] = redis.from_url('redis://localhost:6379')
app.config['SECRET_KEY'] = os.urandom(24)
app.config['JSON_SORT_KEYS'] = False
app.config.from_object(__name__)
# Session(app)
sess = Session()
sess.init_app(app)




CURRENT_SESSION = 1
cur_session_str = 's' + str(CURRENT_SESSION)
RESPONSIVE = 0   # 0: nonresponsive,  1: responsive
# session['current_session'] = CURRENT_SESSION

# r = redis.Redis(host='localhost',port=6379, db=0)
labelDict = {
    0: "None",
    1: "Gun",
    2: "Knife",
    3: "Scissors",
    4: "Wrench",
    5: "Pliers"
}
model_detected_objects = [1,2,3] # list format, no space
ground_truth_objects = [1,2,3,4]

num_unofficial = 10
num_official = 5
count = 0

treatment_dict = {
    0: "noXAI",
    1: "saliencyMap",
    2: "similarInstances"
}
treatment = 1
session_time_limit = 60 # minutes


data = ""
trainData = ""
taskData = ""
# # predSE = [1.266335746,1.181905613,1.56584739,1.312722299,1.034996148,0.888943077,1.691238093,1.451837921,1.142564792,1.017254256,1.278425507,1.673083901,1.33825397,1.213818071,1.557312752,1.311331642,1.816822498,1.282988995,1.925545327,1.532985065,1.433913784,1.359568851,0.947197108,1.070456409,1.75195972,1.602376737,0.880697066,0.894897126,1.020497794,1.081039655,1.573805816,1.382387326,0.982603768,1.302952847,0.776193889,1.367449428,1.333245464,1.615217236,0.910971844,1.561874789,1.713096684,1.287323424,0.880125034,1.407056384,1.517514345,1.261829808,0.883408846,1.374764993,1.232656213,1.323890507,1.286209419,1.547068537,2.02330579,1.323476074,1.877748883,1.553259347,1.395610632,1.69427601,2.0356824,2.152402372,1.247177167,0.979248206,0.931380468,2.005152423,1.696962806,0.951066438,1.078659241,0.8436838,1.096114867,1.474213022,0.840531004,1.634370905,1.317155928,1.251022187,1.29731145,1.919897246,0.95994049,1.11819778,1.480574945,1.044931509,1.151374146,1.094239111,1.374838731,1.599269861,1.174366087,1.178643489,1.406525879,0.987232536,0.970105479,1.173090855,1.443901274,1.052266178,0.923969211,2.048782727,0.915177241,1.424536557,0.882797496,0.999210227,0.778746004,1.780734502,1.270253853,1.15626463,1.302115444,2.030758922,1.225928066,0.999311823,1.384394169,0.957156825,1.538384642,1.400685998,0.838156158,1.469353806,1.796591893,1.110927621,0.88486612,1.107860271,1.949661139,1.254976595,1.518757139,0.835350634,1.496794949,1.149655998,1.381829214,1.611723171,1.54723732,1.366076783,1.825887498,1.870109893,1.326928739,1.080773938,1.636691552,1.195714391,1.314511529,1.03643585,1.600727253,1.337007535,1.416797344,1.047523998,0.739297669,1.213902048,1.172197,1.026825065,1.356644436,1.736343982,1.189516475,1.469155719,1.309882988,1.637038827,0.812423411,1.111282616,0.985125012,1.588062133,1.134719046,0.775057761,1.452838463,1.115523374,1.393353578,1.493776271,1.453540583,1.821729349,1.840146878,1.191142106,1.290619876,1.391875524,1.307404599,1.175944954,1.425108796,0.91614892,1.963427727,1.806250018,1.053168412,0.832449935,0.901826632,1.370004699,0.807400021,1.661637248,1.128715328,1.291032785,1.594650009,0.980213891,1.028667862,1.348002902,1.179970026,0.807981583,0.937452003,2.122109041,1.10034095,1.130828466,1.868567385,1.368991642,0.727564768,1.392347678,1.146759446,1.810333052,1.859068853,1.271598598,1.346064399,1.392149999,1.03741474,1.22630698,1.547625051,1.510739207,1.397628343,1.578972502,1.346612528,1.526368638,1.161280495,2.011935474,1.408297485,1.249597497,1.443724287,1.199196512,0.890738424,0.822988432,1.469765985,1.595191136,1.035069712,1.461957527,1.549483811,1.029337511,0.871900905,1.362637654,1.167811378,0.772060018,0.870340505,1.347817442,1.298463507,1.499096467,0.823629645,1.096373474,1.046262828,1.43924763,1.244841032,1.138884247,1.992003748,1.280150712,1.179315425,1.583341308,1.63971615,1.173081168,1.014631306,0.986084891,1.093213599,1.326377057,1.245816049,1.091803336,1.084827365,0.857845791,1.168145315,1.163618785,1.010251428,1.200674935,1.057046061,1.581094396,1.270124184,1.058665431,1.754911343,1.785281831,1.037808235,1.346008095,1.497953694,1.059639185,0.727103148,0.929141484,0.89826607,1.120703874,0.818744559,1.570359288,2.086372294,1.15836999,1.37422724,1.888238569,0.86871016,1.365165262,1.432929003,1.44852648,1.107985911,1.202478842,1.220175579,1.682286934,1.159792919,1.018993436,1.725988972,0.907221812,0.753022988,0.859645275,2.017530276,1.20881607,1.355166763,1.158177172,1.122319364,0.85254916,1.088263917,1.025448122,2.025638257,0.988064804,1.242929066,1.1826595,1.275782222,0.990198984,1.072629344,1.588324787,1.041191163,1.246081438,0.926443894,1.126002701,1.677234932,1.408630067,0.99265985,1.162045243,0.989031379,1.313794483,1.330719927,0.927785548,1.344707408,1.366115229,0.871769766,1.180632603,2.044039119,1.350941593,1.150658533,1.280726023,0.926223887,1.313627169,1.059951733,1.536436782,1.322188836,1.405522817,1.323391238,1.206173435,1.161111734,1.605587378,0.953201615,1.65244365,1.123594216,1.968626493,1.562807543,0.976330267,1.632222494,1.474632601,0.953216354,1.616868764,1.585841523,1.416993282,1.355706741,1.433636176,1.294288442,1.057343058,0.971754856,1.326640176,1.073110029,1.455661389,1.20881928,1.52498196,1.773830518,1.200414117,1.277217203,1.114562745,1.696298258,1.226606988,1.748146646,1.3605672,1.374456884,0.992155358,1.063584014,1.194379115,1.399660253,1.344676264,1.362732292,1.074869965,1.393707123,1.03679613,1.625719268,1.120931789,1.136004809,1.000008416,1.525077031,0.847332297,1.097225997,1.327250831,0.855977062,1.39286976,1.48185894,1.681505524,1.543606893,2.129315042,1.011917653,1.439294147,0.940157837,0.993963109,1.698366108,1.094984079,1.438236477,0.908311386,0.91503726,0.8019576,1.568416083,1.398643085,1.060329149,1.73274409,0.966253433,1.071910279,1.364178577,1.341616424,1.376766698,1.283149012,1.146628247,1.415328093,1.433864337,1.818960149,1.786830693,1.460183105,1.6295943,0.988354736,1.287896715,2.168527227,1.181525683,1.380606552,1.616145336,0.830090585,1.227906085,0.954503455,1.928022019,1.764502212,0.857593249,2.065387011,0.980190688,0.879337828,1.684999134,1.158579397,1.162825379,1.915372977,0.939069809,1.941512667,1.266022869,0.780138565,1.330828642,1.071344588,1.359122282,1.358173746,1.366420359,1.136529853,1.655723156,0.841471596,1.638301142,1.121257587,1.04637571,1.386980326,0.977141524,1.147308635,1.082430426,1.321090632,1.683243055,1.728041692,0.934700758,1.106514791,1.039599922,1.401219578,1.217876651,0.901291551,1.363894882,1.093268876,1.558942906,1.181676273,1.249708238,1.919688581,1.332134628,1.822442088,1.547592459,1.100517937,1.487028297,0.925058198,1.251297635,1.552396394,1.634910144,0.96241833,1.349094526,2.134443577,1.44437915,2.031433073,2.495845839,1.716915868,2.84564844,1.343564423,2.859284248,2.281452092,1.53715959,2.480838596,1.644835875,2.849883616,1.568467713,1.695609553,2.387265826,2.583323336,2.383896609,2.36737397,2.230333277,1.801269666]
pred_interval_arr = [11.73298953,11.72417749,11.76908302,11.73808659,11.71027985,11.69827581,11.78642114,11.75445747,11.72027693,11.70872509,11.73430053,11.78382989,11.74096933,11.72743754,11.76795055,11.73793115,11.80509555,11.73479858,11.82231626,11.76475585,11.75225705,11.74341792,11.70284664,11.71346721,11.79528719,11.77399882,11.69765209,11.69872976,11.70900734,11.71443912,11.77014451,11.74608155,11.70576555,11.73699805,11.69024867,11.74433289,11.7403995,11.77575321,11.69997037,11.76855513,11.78957749,11.73527327,11.69760903,11.74901037,11.76274997,11.73250406,11.69785657,11.74518692,11.7294023,11.73934083,11.73515112,11.76659926,11.83863182,11.7392941,11.81462559,11.76741482,11.74764513,11.78685744,11.84075335,11.86137737,11.73093721,11.70548436,11.7015771,11.8355428,11.78724394,11.70316045,11.71421968,11.69492366,11.71583991,11.75724207,11.69469664,11.7783957,11.73858325,11.73134662,11.73637312,11.82139765,11.70388494,11.71792658,11.75804147,11.71116215,11.721139,11.71566457,11.74519555,11.7735764,11.72341984,11.72384909,11.74894685,11.70615501,11.70472305,11.72329217,11.75347982,11.71181887,11.70098954,11.84301261,11.70029856,11.7511166,11.69781041,11.70717123,11.6904184,11.79959543,11.73341305,11.72162041,11.73690512,11.83990789,11.72869714,11.7071799,11.7463179,11.70365696,11.76546065,11.74824916,11.69452619,11.75663377,11.80199896,11.71723505,11.69796671,11.71694463,11.82626803,11.73176898,11.76291037,11.69432545,11.7600949,11.72097035,11.74601588,11.77527446,11.76662145,11.74417314,11.80649407,11.8134139,11.73968385,11.7144146,11.77871794,11.7255776,11.73828683,11.71040718,11.77377445,11.74082732,11.75018092,11.71139375,11.68785687,11.72744624,11.72320276,11.70956049,11.74307971,11.79297789,11.72494719,11.75660902,11.7377694,11.7787662,11.69271007,11.71726871,11.70597746,11.77205922,11.71951468,11.69017329,11.75458109,11.71767167,11.74737721,11.75971108,11.75466789,11.80585172,11.8087077,11.72511222,11.73563534,11.74720199,11.73749308,11.72357811,11.75118599,11.70037461,11.82854537,11.80347306,11.71189996,11.6941186,11.69926187,11.74463069,11.69236212,11.78221012,11.71893491,11.73568075,11.77294975,11.70556519,11.70972223,11.74208452,11.72398253,11.69240229,11.70206193,11.85591767,11.71623605,11.71913862,11.81316982,11.74451256,11.68712058,11.74725794,11.7206866,11.80409856,11.81167109,11.73355871,11.74186214,11.74723451,11.71049386,11.72873675,11.76667244,11.76187783,11.747885,11.77083647,11.74192498,11.76389554,11.72211625,11.83669385,11.74915907,11.73119478,11.75345808,11.7259332,11.69841237,11.69344889,11.75668529,11.77302305,11.71028635,11.75571167,11.76691706,11.70978107,11.69699313,11.7437736,11.72276505,11.68997492,11.69687692,11.74206323,11.73650052,11.76038806,11.69349404,11.71586411,11.71128101,11.75290904,11.73068908,11.7199187,11.83332227,11.73448861,11.72391666,11.77142331,11.7791386,11.7232912,11.7084975,11.70605828,11.71556883,11.73962151,11.73079259,11.71543732,11.71478926,11.69595385,11.72279832,11.72234813,11.70811876,11.72608449,11.71224929,11.7711213,11.73339902,11.71239555,11.79572596,11.80028255,11.71052872,11.74185568,11.76024244,11.71248361,11.68709186,11.7013991,11.69898795,11.71816599,11.69315097,11.76968417,11.84957326,11.72182827,11.74512399,11.8162973,11.69675572,11.74406715,11.75213694,11.75404892,11.71695651,11.72626933,11.72809727,11.78514007,11.72196898,11.70887632,11.79145771,11.69967899,11.68873307,11.69608597,11.83764611,11.72692088,11.74290909,11.72180922,11.71832061,11.69556656,11.715108,11.70943982,11.83903068,11.70622523,11.73048634,11.72425352,11.73401284,11.70640556,11.71366598,11.77209466,11.71082901,11.73082077,11.70118521,11.71867395,11.78441997,11.74919894,11.70661397,11.72219204,11.70630685,11.73820655,11.74011297,11.70129151,11.74170665,11.74417762,11.69698335,11.72404923,11.84219291,11.74242225,11.72106873,11.73455138,11.70116779,11.73818782,11.71251189,11.76520612,11.73914905,11.74882681,11.73928454,11.72664877,11.72209954,11.7744362,11.70333416,11.78091707,11.71844277,11.82940942,11.76867896,11.70524061,11.77809778,11.75729469,11.70333536,11.77597986,11.77175987,11.75020455,11.74297142,11.75222318,11.73603935,11.7122761,11.70485987,11.73965124,11.71371001,11.75493033,11.72692121,11.7637157,11.79855549,11.72605778,11.73416895,11.71758026,11.78714829,11.72876813,11.79472144,11.74353355,11.74515086,11.7065712,11.71284116,11.72544151,11.74812691,11.74170308,11.74378458,11.71387137,11.74741915,11.71043907,11.77719832,11.71818779,11.71963924,11.70723938,11.76372802,11.69518743,11.71594392,11.73972026,11.69581694,11.74731983,11.75820322,11.78502855,11.76614462,11.8572096,11.70826265,11.75291473,11.702279,11.70672455,11.78744605,11.71573417,11.75278525,11.69976353,11.70028761,11.69198756,11.76942505,11.74800577,11.71254605,11.79244839,11.70440442,11.71360016,11.7439525,11.74135306,11.74542139,11.73481608,11.72067376,11.75000386,11.75225102,11.80542473,11.80051698,11.75549113,11.77773385,11.7062497,11.73533617,11.86431403,11.7241392,11.7458721,11.77588055,11.69395089,11.72890406,11.70344026,11.82271991,11.79715665,11.69593533,11.84589636,11.70556324,11.69754983,11.78552753,11.72184897,11.7222694,11.82066372,11.70219164,11.82492742,11.73295576,11.69051125,11.74012529,11.71354841,11.74336623,11.74325649,11.74421311,11.71969015,11.78137752,11.69476428,11.7789417,11.71821896,11.7112911,11.74662298,11.70530831,11.72074034,11.71456754,11.73902541,11.78527659,11.79175836,11.70184184,11.71681749,11.71068764,11.74831279,11.72785831,11.69922064,11.74391955,11.71557399,11.76816638,11.72415438,11.73120658,11.82136377,11.74027341,11.80596172,11.76666816,11.71625268,11.75885582,11.70107558,11.731376,11.76730095,11.77847054,11.70408844,11.74220989,11.85813166,11.75353854,11.84002354,11.92848203,11.79013304,12.00654622,11.74157581,12.00978532,11.88547267,11.76530053,11.92535103,11.77985238,12.00755069,11.76943193,11.7870492,11.90623682,11.94709155,11.90556173,11.90226435,11.87576623,11.80271195]

# # the file name to store the worker IDs
# workerID_filename = 'workerIDs_complete.csv'
# workerIDs_log = 'workerIDs_only.csv'

# # read model output data csv file
# all_data = pd.read_csv('Admission_Predict_Ver1.1.csv')
# # transfer the target variable to percentile
# targetList = list(all_data['Chance of Admit '])
# all_data['Chance of Admit '] = [round(percentileofscore(targetList, a, 'strict'), 1) for a in targetList]
# all_data.columns = all_data.columns.str.replace(' ', '')

# trainData = pd.DataFrame([
#     # [492, 297, 99, 3.5, 7.81, 0, 10.6, 16.07963183, -7.011287715, 39.17055138, 11.75225705, 1.433913784, 'lowvariance'],
#     [462, 301, 102, 2, 8.13, 1, 35.6, 23.64932489, 0.473859419, 46.82479037, 11.79528719, 1.75195972, 'lowvariance'],
#     [424, 334, 119, 5, 9.54, 1, 94, 97.95787622, 74.87483141, 121.040921, 11.74824916, 1.400685998, 'lowvariance'],
#     [209, 305, 106, 3, 8.16, 0, 25.4, 27.05548017, 4.044849131, 50.06611121, 11.71139375, 1.047523998, 'lowvariance'],
#     [339, 323, 108, 4, 8.74, 1, 71.6, 60.48718448, 37.51172292, 83.46264604, 11.69349404, 0.823629645, 'lowvariance'],
#     [417, 315, 104, 2.5, 8.1, 0, 29.2, 27.29515504, 4.276579166, 50.31373091, 11.71543732, 1.091803336, 'lowvariance'],
#     # [97, 306, 100, 3, 8, 0, 5.8, 22.4805078, -0.531804208, 45.49281981, 11.71224929, 1.057046061, 'lowvariance'],
#     [300, 305, 112, 3.5, 8.65, 0, 42.6, 41.92956951, 18.67274793, 65.1863911, 11.83669385, 2.011935474, 'lowvariance'],
#     [126, 300, 100, 3, 8.66, 1, 25.4, 38.12210056, 14.83997343, 61.40422769, 11.84957326, 2.086372294, 'lowvariance'],
#     [188, 335, 118, 3.5, 9.44, 1, 91.6, 89.1175831, 66.04434792, 112.1908183, 11.74325649, 1.358173746, 'lowvariance'],
#     [294, 312, 98, 3, 8.18, 1, 25.4, 29.66859032, 6.512793748, 52.82438689, 11.78527659, 1.683243055, 'lowvariance'],
#     [11, 325, 106, 4, 8.4, 1, 8.2, 51.34800005, 28.27806709, 74.41793301, 11.74157581, 1.343564423, 'highvariance']
#     # [298, 320, 120, 4.5, 9.11, 0, 79.4, 64.5117869, 40.91487395, 88.10869985, 12.00978532, 2.859284248, 'highvariance']
#     ],
#     columns=["SerialNo.", "GREScore", "TOEFLScore", "LOR", "CGPA", "Research", "ChanceofAdmit", "predicted", "lower95", "upper95", "sdpi", "sdci","flag"])
# trainData = json.dumps(trainData.to_dict(orient='records'), indent=2)  # convert to json string


# taskData = pd.DataFrame([
#     [237, 325, 112, 4.5, 9.17, 1, 78.20, 77.18, 54.20, 100.16, 11.69581694, 0.855977062, 'lowvariance'],
#     [102, 312, 105, 3, 8.12, 0, 25.40, 28.74, 5.75, 51.72, 11.69872976, 0.894897126, 'lowvariance'],
#     [382, 319, 105, 3.5, 8.67, 1, 50.40, 52.52, 29.52, 75.51, 11.70472305, 0.970105479, 'lowvariance'],
#     [116, 310, 106, 4.5, 9.04, 1, 31.60, 62.61, 39.50, 85.73, 11.765300534, 1.53715959, 'highvariance'],
#     [412, 313, 94, 1.5, 8.13, 0, 12.60, 21.33, -2.10, 44.77, 11.92535103, 2.480838596, 'highvariance'],
#     # [466, 305, 96, 4.5, 8.26, 0, 10.6, 33.50, 10.20, 56.80, 11.85813166, 2.134443577, 'highvariance'],
#     [67, 327, 114, 3.0, 9.02, 0, 19.40, 58.09, 34.83, 81.35, 11.840023538, 2.031433073, 'highvariance']],
#     columns=["SerialNo.", "GREScore", "TOEFLScore", "LOR", "CGPA", "Research", "ChanceofAdmit", "predicted", "lower95", "upper95", "sdpi", "sdci", "flag"])
# # taskDataJson = json.loads(taskData.to_json(orient="records"))
# taskData = json.dumps(taskData.to_dict(orient='records'), indent=2)  # convert to json string



# def dataRender(all_data):
#     # transfer it
#     feature_data = all_data.copy()
#     feature_data = feature_data.astype(str).transpose()

#     chart_data = feature_data.to_dict(orient='records')
#     chart_data = json.dumps(chart_data, indent=2)
#     # randomized order for official prediction tasks
#     x1 = list(range(1, (num_official+1)))
#     x2 = list(range(1, (num_official+1)))
#     x3 = list(range(1, (num_official+1)))
#     x4 = list(range(1, (num_official+1)))
#     x5 = list(range(1, (num_official+1)))
#     random.Random(4).shuffle(x1)
#     random.Random(7).shuffle(x2)
#     random.Random(6).shuffle(x3)
#     random.Random(5).shuffle(x4)
#     random.Random(8).shuffle(x5)
#     # randomized order for training
#     trainorder = list(range(1, (num_unofficial+1)))
#     random.Random(2).shuffle(trainorder)

#     data = {
#         'chart_data': chart_data,
#         'order1': x1,
#         'order2': x2,
#         'order3': x3,
#         'order4': x4,
#         'order5': x5,
#         'trainorder': trainorder
#     }

 
#     return data

# data = dataRender(all_data)

# def limitBounds(x):
#     # if x >= 100.00:
#     #     return 100.00
#     # elif x <= 0.00:
#     #     return 0.00
#     # else:
#     #     return x
#     return x

# def is_blank(s):
#     return bool((s is None) or (str(s).strip() == ""))


# def loadQuiz():
#     # questionNum = 3
#     with open('quiz_pool.json') as f:
#     # with open('trustrepair_quizpool.json') as f:
#         data = json.load(f)
#         # length = len(data)
#         # sampleIndex = random.sample(range(2, length), questionNum)
#         # tmpArr = [data[i] for i in sampleIndex]
#         quesitonArr = []
#         quesitonArr.append(data[0])
#         quesitonArr.append(data[1])
#         quesitonArr.append(data[2])
#         # for i in sampleIndex:
#         #     quesitonArr.append(data[i])
#     return quesitonArr

def loadQuiz():
    # questionNum = 3
    # with open('quiz_pool.json') as f:
    with open("trustrepair_quizpool_" + cur_session_str + ".json") as f:
        data = json.load(f)
        quesitonArr = []
        for i in range(0, len(data)):
            quesitonArr.append(data[i])
    return quesitonArr


def getTrainVisOrder():
    # trainvislist = ['modelonly', 'uncertaintybound', 'uncertaintylevel']
    # viscount = [4, 3, 3]
    trainvislist = ['uncertaintybound', 'uncertaintylevel']
    viscount = [5, 5]
    trainvisorder = []
    for vis, count in zip(trainvislist, viscount):
        for i in range(count):
            trainvisorder.append(vis)
    return trainvisorder

trainvisorder = getTrainVisOrder()




    
@app.route("/")
def index(data=data, num_official=num_official):


    r = redis.Redis(db=0)


    return render_template("interface.html", current_session = CURRENT_SESSION)
    # return render_template("trustrepair_chat2.html", num=num, taskNum=num_official, modelDetectedLabels=model_detected_objects, groundTruthDetectedLabels=ground_truth_objects)



if __name__ == "__main__":
    app.config['JSON_SORT_KEYS'] = False
    app.run(debug=True, threaded=True, host='0.0.0.0')
    app.config["TEMPLATES_AUTO_RELOAD"] = True
    app.config['SECRET_KEY'] = os.urandom(24)
    app.config['JSON_SORT_KEYS'] = False
    app.config['SESSION_TYPE'] = 'redis'
